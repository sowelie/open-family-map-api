name: Build & Publish Docker Image

# 1️⃣  Trigger on *any* tag creation or push of an existing tag
on:
    push:
        tags: #  <-- Only run for tags
            - "*"

env:
    # The image will be tagged with the exact tag name that triggered the workflow
    IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/${{ github.repository }}

jobs:
    build-and-publish:
        runs-on: ubuntu-latest
        permissions:
            # Needed for `docker/login-action` (write to GHCR) and for creating a release
            contents: read
            packages: write
            actions: read
            security-events: read # optional, just a safety net
        steps:
            # 2️⃣  Grab your source code
            - name: Checkout repository
              uses: actions/checkout@v4

            # 4️⃣  Log into GitHub Container Registry
            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.repository_owner }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            # 5️⃣  Build & Tag the image
            - name: Build and tag
              env:
                  DOCKERFILE_PATH: open-family-map-api/Dockerfile
                  CONTEXT_PATH: open-family-map-api/
              run: |
                    TAG=${{ github.ref_name }}

                    # Build (the `dockerfile:` keyword is optional if the file is named
                    # `Dockerfile` and sits next to the build‑context folder)
                    docker build \
                        --file "$DOCKERFILE_PATH" \
                        --tag "$IMAGE_NAME:$TAG" \
                        --tag "$IMAGE_NAME:latest" \
                        "$CONTEXT_PATH"

            # 6️⃣  Push the image to GHCR
            - name: Push image
              run: |
                  TAG=${{ github.ref_name }}
                  docker push $IMAGE_NAME:$TAG
                  # Push latest tag if you added it above
                  docker push $IMAGE_NAME:latest
